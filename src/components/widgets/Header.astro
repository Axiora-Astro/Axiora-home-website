---
import { Icon } from 'astro-icon/components';
---

<header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="/Axiora-photos/Axiora-logo.jpg" alt="Axiora Logo" class="w-8 h-8 mr-2 rounded" />
        <span class="text-2xl font-bold text-gray-900 dark:text-white">Axiora</span>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex space-x-8">
        <div class="relative group">
          <button class="flex items-center text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">
            Products
            <Icon name="tabler:chevron-down" class="w-4 h-4 ml-1" />
          </button>
          <div class="absolute top-full left-0 mt-1 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
            <a href="#hero" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Axiora Desktop</a>
          </div>
        </div>
        <a href="#see-axiora" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">See Axiora</a>
        <a href="#trial-code" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Trial Code</a>
        <a href="#footer" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Contact Us</a>
      </nav>

      <!-- Action Buttons -->
      <div class="flex items-center space-x-4">
        <!-- Theme Toggle -->
        <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
          <Icon name="tabler:sun" class="w-5 h-5 dark:hidden" />
          <Icon name="tabler:moon" class="w-5 h-5 hidden dark:block" />
        </button>

        <!-- User Icon -->
        <button id="user-menu-toggle" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 hidden md:block">
          <Icon name="tabler:user-circle" class="w-6 h-6 text-gray-700 dark:text-gray-200" />
        </button>

        <a href="/coming-soon" class="btn btn-secondary hidden md:inline-block">Download</a>
        <a href="/coming-soon" class="btn btn-primary hidden md:inline-block">Try Online</a>

        <!-- Mobile menu button -->
        <button id="mobile-menu-toggle" class="md:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
          <Icon name="tabler:menu-2" class="w-6 h-6" />
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="md:hidden hidden pb-4">
      <div class="space-y-2">
        <a href="#hero" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Axiora Desktop</a>
        <a href="#see-axiora" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">See Axiora</a>
        <a href="#trial-code" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Trial Code</a>
        <a href="#footer" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Contact Us</a>
      </div>
    </div>
  </div>
</header>

<!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 p-6 relative">
    <!-- Close Button -->
    <button id="close-modal" class="absolute top-4 right-4 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
      <Icon name="tabler:x" class="w-5 h-5 text-gray-500 dark:text-gray-400" />
    </button>

    <!-- Modal Header -->
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome to Axiora</h2>
      <p class="text-gray-600 dark:text-gray-400">Sign in to access your account</p>
    </div>

    <!-- Login Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
      <button id="tab-signin" class="flex-1 py-2 text-center font-medium border-b-2 border-blue-600 text-blue-600 dark:text-blue-400">
        Sign In
      </button>
      <button id="tab-signup" class="flex-1 py-2 text-center font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
        Sign Up
      </button>
    </div>

    <!-- Sign In Form -->
    <div id="signin-form" class="space-y-4">
      <form id="email-signin-form" class="space-y-4">
        <div>
          <label for="signin-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Email
          </label>
          <input
            type="email"
            id="signin-email"
            name="email"
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="you@example.com"
          />
        </div>
        <div>
          <label for="signin-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Password
          </label>
          <input
            type="password"
            id="signin-password"
            name="password"
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="••••••••"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
        >
          <Icon name="tabler:login" class="w-5 h-5 mr-2" />
          Sign In
        </button>
      </form>

      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">Or continue with</span>
        </div>
      </div>

      <button
        id="google-signin-btn"
        type="button"
        class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
      >
        <Icon name="flat-color-icons:google" class="w-5 h-5 mr-2" />
        Sign in with Google
      </button>

      <div class="text-center text-sm">
        <a href="#" class="text-blue-600 dark:text-blue-400 hover:underline">Forgot password?</a>
      </div>
    </div>

    <!-- Sign Up Form -->
    <div id="signup-form" class="space-y-4 hidden">
      <form id="email-signup-form" class="space-y-4">
        <div>
          <label for="signup-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Email
          </label>
          <input
            type="email"
            id="signup-email"
            name="email"
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="you@example.com"
          />
        </div>
        <div>
          <label for="signup-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Password
          </label>
          <input
            type="password"
            id="signup-password"
            name="password"
            required
            minlength="6"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="••••••••"
          />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Minimum 6 characters</p>
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
        >
          <Icon name="tabler:user-plus" class="w-5 h-5 mr-2" />
          Create Account
        </button>
      </form>

      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">Or continue with</span>
        </div>
      </div>

      <button
        id="google-signup-btn"
        type="button"
        class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
      >
        <Icon name="flat-color-icons:google" class="w-5 h-5 mr-2" />
        Sign up with Google
      </button>
    </div>

    <!-- Success/Error Messages -->
    <div id="auth-message" class="mt-4 p-3 rounded-md hidden">
      <p id="auth-message-text" class="text-sm"></p>
    </div>
  </div>
</div>

<script>
  // Theme toggle
  document.getElementById('theme-toggle')?.addEventListener('click', () => {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark');

    if (isDark) {
      html.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    } else {
      html.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    }
  });

  // Mobile menu toggle
  document.getElementById('mobile-menu-toggle')?.addEventListener('click', () => {
    const menu = document.getElementById('mobile-menu');
    menu?.classList.toggle('hidden');
  });

  // Modal functionality
  const modal = document.getElementById('login-modal');
  const userMenuToggle = document.getElementById('user-menu-toggle');
  const closeModal = document.getElementById('close-modal');
  const tabSignin = document.getElementById('tab-signin');
  const tabSignup = document.getElementById('tab-signup');
  const signinForm = document.getElementById('signin-form');
  const signupForm = document.getElementById('signup-form');

  // Open modal
  userMenuToggle?.addEventListener('click', () => {
    modal?.classList.remove('hidden');
    modal?.classList.add('flex');
  });

  // Close modal
  closeModal?.addEventListener('click', () => {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
  });

  // Close modal on outside click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  });

  // Tab switching
  tabSignin?.addEventListener('click', () => {
    tabSignin.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignin.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    tabSignup?.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignup?.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    signinForm?.classList.remove('hidden');
    signupForm?.classList.add('hidden');
  });

  tabSignup?.addEventListener('click', () => {
    tabSignup.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignup.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    tabSignin?.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignin?.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    signupForm?.classList.remove('hidden');
    signinForm?.classList.add('hidden');
  });

  // API Configuration
  const API_URL = 'http://localhost:4412'; // Change to your backend URL in production

  // Helper function to show messages
  function showMessage(message: string, isError = false) {
    const messageDiv = document.getElementById('auth-message');
    const messageText = document.getElementById('auth-message-text');
    
    if (messageDiv && messageText) {
      messageText.textContent = message;
      messageDiv.classList.remove('hidden');
      
      if (isError) {
        messageDiv.classList.add('bg-red-100', 'dark:bg-red-900/20', 'border', 'border-red-400', 'dark:border-red-700');
        messageDiv.classList.remove('bg-green-100', 'dark:bg-green-900/20', 'border-green-400', 'dark:border-green-700');
        messageText.classList.add('text-red-700', 'dark:text-red-300');
        messageText.classList.remove('text-green-700', 'dark:text-green-300');
      } else {
        messageDiv.classList.add('bg-green-100', 'dark:bg-green-900/20', 'border', 'border-green-400', 'dark:border-green-700');
        messageDiv.classList.remove('bg-red-100', 'dark:bg-red-900/20', 'border-red-400', 'dark:border-red-700');
        messageText.classList.add('text-green-700', 'dark:text-green-300');
        messageText.classList.remove('text-red-700', 'dark:text-red-300');
      }
      
      setTimeout(() => {
        messageDiv.classList.add('hidden');
      }, 5000);
    }
  }

  // Email Sign In
  document.getElementById('email-signin-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const email = (form.elements.namedItem('email') as HTMLInputElement).value;
    const password = (form.elements.namedItem('password') as HTMLInputElement).value;

    try {
      const response = await fetch(`${API_URL}/api/v1/auth/signin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();

      if (response.ok) {
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('refresh_token', data.refresh_token);
        localStorage.setItem('user', JSON.stringify(data.user));
        showMessage('Successfully signed in!');
        
        setTimeout(() => {
          modal?.classList.add('hidden');
          modal?.classList.remove('flex');
          window.location.reload(); // Reload to update UI
        }, 1500);
      } else {
        showMessage(data.detail || 'Sign in failed', true);
      }
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });

  // Email Sign Up
  document.getElementById('email-signup-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const email = (form.elements.namedItem('email') as HTMLInputElement).value;
    const password = (form.elements.namedItem('password') as HTMLInputElement).value;

    try {
      const response = await fetch(`${API_URL}/api/v1/auth/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();

      if (response.ok) {
        if (data.email_confirmed) {
          localStorage.setItem('access_token', data.access_token);
          localStorage.setItem('refresh_token', data.refresh_token);
          localStorage.setItem('user', JSON.stringify(data.user));
          showMessage('Account created successfully!');
          
          setTimeout(() => {
            modal?.classList.add('hidden');
            modal?.classList.remove('flex');
            window.location.reload();
          }, 1500);
        } else {
          showMessage('Account created! Please check your email to verify your account.');
          form.reset();
        }
      } else {
        showMessage(data.detail || 'Sign up failed', true);
      }
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });

  // Google Sign In
  document.getElementById('google-signin-btn')?.addEventListener('click', async () => {
    try {
      const response = await fetch(`${API_URL}/api/v1/auth/google/signin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ redirect_url: window.location.origin + '/auth/callback' })
      });

      const data = await response.json();

      if (response.ok) {
        window.location.href = data.url;
      } else {
        showMessage('Google sign in failed', true);
      }
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });

  // Google Sign Up (same as sign in for OAuth)
  document.getElementById('google-signup-btn')?.addEventListener('click', async () => {
    try {
      const response = await fetch(`${API_URL}/api/v1/auth/google/signin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ redirect_url: window.location.origin + '/auth/callback' })
      });

      const data = await response.json();

      if (response.ok) {
        window.location.href = data.url;
      } else {
        showMessage('Google sign up failed', true);
      }
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });
</script>
