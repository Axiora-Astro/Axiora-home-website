---
import { Icon } from 'astro-icon/components';
---

<header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-4">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="/Axiora-photos/Axiora-logo.jpg" alt="Axiora Logo" class="w-8 h-8 mr-2 rounded" />
        <span class="text-2xl font-bold text-gray-900 dark:text-white">Axiora</span>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex space-x-8">
        <div class="relative group">
          <button class="flex items-center text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">
            Products
            <Icon name="tabler:chevron-down" class="w-4 h-4 ml-1" />
          </button>
          <div class="absolute top-full left-0 mt-1 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
            <a href="#hero" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Axiora Desktop</a>
          </div>
        </div>
        <a href="#see-axiora" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">See Axiora</a>
        <a href="/pricing" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Pricing</a>
        <a href="#trial-code" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Trial Code</a>
        <a href="#footer" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Contact Us</a>
      </nav>

      <!-- Action Buttons -->
      <div class="flex items-center space-x-4">
        <!-- Theme Toggle -->
        <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
          <Icon name="tabler:sun" class="w-5 h-5 dark:hidden" />
          <Icon name="tabler:moon" class="w-5 h-5 hidden dark:block" />
        </button>

        <!-- Sign In Button (Shown when not logged in) -->
        <button id="signin-btn" class="hidden p-2 rounded-md hover:bg-green-100 dark:hover:bg-green-900/30 items-center gap-2 text-green-600 dark:text-green-400">
          <Icon name="tabler:login" class="w-5 h-5" />
          <span class="text-sm font-medium">Sign In</span>
        </button>
        
        <!-- User Profile (Hidden by default, shown when logged in) -->
        <div class="relative hidden md:block" id="user-profile-container">
          <button id="user-profile" class="hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 md:flex flex-col items-center gap-1">
            <div class="relative">
              <Icon id="user-icon" name="tabler:user-circle" class="w-10 h-10 text-gray-700 dark:text-gray-200" />
              <img id="user-avatar" src="" alt="User Avatar" class="w-10 h-10 rounded-full hidden" style="border: 3px solid transparent;" />
              <!-- Plan Badge -->
              <span id="plan-badge" class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 px-1.5 py-0.5 text-[8px] font-semibold rounded-full bg-gray-800 text-white hidden whitespace-nowrap"></span>
            </div>
            <span id="user-display-name" class="text-xs font-medium text-gray-700 dark:text-gray-200"></span>
          </button>
          
          <!-- User Dropdown Menu -->
          <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg hidden z-50 border border-gray-200 dark:border-gray-700">
            <button id="edit-profile-btn" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
              <Icon name="tabler:user-edit" class="w-4 h-4" />
              Edit Profile
            </button>
            <button id="see-usage-btn" class="w-full text-left px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
              <Icon name="tabler:chart-bar" class="w-4 h-4" />
              See Usage
            </button>
          </div>
        </div>
        
        <!-- Logout Button (Hidden by default, shown when logged in) -->
        <button id="logout-btn" class="hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 items-center gap-2 text-red-600 dark:text-red-400">
          <Icon name="tabler:logout" class="w-5 h-5" />
          <span class="text-sm font-medium">Logout</span>
        </button>

        <a href="/coming-soon" class="btn btn-secondary hidden md:inline-block">Download</a>
        <a href="/coming-soon" class="btn btn-primary hidden md:inline-block">Try Online</a>

        <!-- Mobile menu button -->
        <button id="mobile-menu-toggle" class="md:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
          <Icon name="tabler:menu-2" class="w-6 h-6" />
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="md:hidden hidden pb-4">
      <div class="space-y-2">
        <a href="#hero" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Axiora Desktop</a>
        <a href="#see-axiora" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">See Axiora</a>
        <a href="/pricing" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Pricing</a>
        <a href="#trial-code" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Trial Code</a>
        <a href="#footer" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400">Contact Us</a>
      </div>
    </div>
  </div>
</header>

<!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 p-6 relative">
    <!-- Close Button -->
    <button id="close-edit-profile" class="absolute top-4 right-4 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
      <Icon name="tabler:x" class="w-5 h-5 text-gray-500 dark:text-gray-400" />
    </button>

    <!-- Modal Header -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Edit profile</h2>
    </div>

    <!-- Profile Image -->
    <div class="flex justify-center mb-6">
      <div class="relative">
        <img id="edit-avatar-preview" src="" alt="Profile" class="w-32 h-32 rounded-full border-4 border-white dark:border-gray-700 shadow-lg" />
        <button id="change-avatar-btn" class="absolute bottom-0 right-0 p-2 bg-gray-800 dark:bg-gray-600 rounded-full hover:bg-gray-700 dark:hover:bg-gray-500 transition">
          <Icon name="tabler:camera" class="w-5 h-5 text-white" />
        </button>
        <input type="file" id="avatar-upload" accept="image/*" class="hidden" />
      </div>
    </div>

    <!-- Edit Form -->
    <form id="edit-profile-form" class="space-y-4">
      <div>
        <label for="edit-display-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
          Display name
        </label>
        <input
          type="text"
          id="edit-display-name"
          name="display_name"
          required
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
          placeholder="Your name"
        />
      </div>
      
      <div class="flex gap-3 pt-4">
        <button
          type="button"
          id="cancel-edit-profile"
          class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition duration-200"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200"
        >
          Save
        </button>
      </div>
    </form>

    <!-- Success/Error Messages -->
    <div id="edit-profile-message" class="mt-4 p-3 rounded-md hidden">
      <p id="edit-profile-message-text" class="text-sm"></p>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 p-6 relative">
    <!-- Close Button -->
    <button id="close-modal" class="absolute top-4 right-4 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
      <Icon name="tabler:x" class="w-5 h-5 text-gray-500 dark:text-gray-400" />
    </button>

    <!-- Modal Header -->
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome to Axiora</h2>
      <p class="text-gray-600 dark:text-gray-400">Sign in to access your account</p>
    </div>

    <!-- Login Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
      <button id="tab-signin" class="flex-1 py-2 text-center font-medium border-b-2 border-blue-600 text-blue-600 dark:text-blue-400">
        Sign In
      </button>
      <button id="tab-signup" class="flex-1 py-2 text-center font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
        Sign Up
      </button>
    </div>

    <!-- Sign In Form -->
    <div id="signin-form" class="space-y-4">
      <form id="email-signin-form" class="space-y-4">
        <div>
          <label for="signin-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Email
          </label>
          <input
            type="email"
            id="signin-email"
            name="email"
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="you@example.com"
          />
        </div>
        <div>
          <label for="signin-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Password
          </label>
          <input
            type="password"
            id="signin-password"
            name="password"
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
        >
          <Icon name="tabler:login" class="w-5 h-5 mr-2" />
          Sign In
        </button>
      </form>

      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">Or continue with</span>
        </div>
      </div>

      <button
        id="google-signin-btn"
        type="button"
        class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
      >
        <Icon name="flat-color-icons:google" class="w-5 h-5 mr-2" />
        Sign in with Google
      </button>

      <div class="text-center text-sm">
        <a href="#" class="text-blue-600 dark:text-blue-400 hover:underline">Forgot password?</a>
      </div>
    </div>

    <!-- Sign Up Form -->
    <div id="signup-form" class="space-y-4 hidden">
      <form id="email-signup-form" class="space-y-4">
        <div>
          <label for="signup-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Display Name
          </label>
          <input
            type="text"
            id="signup-name"
            name="name"
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="John Doe"
          />
        </div>
        <div>
          <label for="signup-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Email
          </label>
          <input
            type="email"
            id="signup-email"
            name="email"
            required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="you@example.com"
          />
        </div>
        <div>
          <label for="signup-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Password
          </label>
          <input
            type="password"
            id="signup-password"
            name="password"
            required
            minlength="6"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Minimum 6 characters</p>
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
        >
          <Icon name="tabler:user-plus" class="w-5 h-5 mr-2" />
          Create Account
        </button>
      </form>

      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">Or continue with</span>
        </div>
      </div>

      <button
        id="google-signup-btn"
        type="button"
        class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
      >
        <Icon name="flat-color-icons:google" class="w-5 h-5 mr-2" />
        Sign up with Google
      </button>
    </div>

    <!-- Success/Error Messages -->
    <div id="auth-message" class="mt-4 p-3 rounded-md hidden">
      <p id="auth-message-text" class="text-sm"></p>
    </div>
  </div>
</div>

<script>
  // Desktop Login Detection
  (async function() {
    const urlParams = new URLSearchParams(window.location.search);
    const isDesktopLogin = urlParams.get('desktop_login') === 'true';
    const desktopCallback = urlParams.get('desktop_callback');
    
    if (isDesktopLogin && desktopCallback) {
      // Decode and store desktop callback for later use
      const decodedCallback = decodeURIComponent(desktopCallback);
      localStorage.setItem('desktop_callback', decodedCallback);
      
      // Wait a bit for page to fully load
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Check localStorage first (faster and more reliable for our use case)
      const localAccessToken = localStorage.getItem('access_token');
      console.log('Desktop login check - localStorage token:', !!localAccessToken);
      
      if (localAccessToken) {
        // User is already logged in (has token in localStorage) - redirect directly
        console.log('User already logged in (localStorage), redirecting to backend...');
        const callbackUrl = `${decodedCallback}&access_token=${localAccessToken}`;
        localStorage.removeItem('desktop_callback');
        window.location.href = callbackUrl;
        return; // Stop here, don't open modal
      }
      
      // Also check Supabase session as fallback
      const { supabase } = await import('../../lib/supabase');
      const { data: { session }, error } = await supabase.auth.getSession();
      
      console.log('Desktop login check - Supabase session:', { hasSession: !!session, hasToken: !!session?.access_token, error });
      
      if (session && session.access_token) {
        // User is logged in via Supabase - redirect directly
        console.log('User already logged in (Supabase), redirecting to backend...');
        const accessToken = session.access_token;
        const callbackUrl = `${decodedCallback}&access_token=${accessToken}`;
        localStorage.removeItem('desktop_callback');
        window.location.href = callbackUrl;
        return; // Stop here, don't open modal
      }
      
      // User not logged in - open login modal
      console.log('User not logged in, opening modal...');
      const modal = document.getElementById('login-modal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
      
      // Update modal header to show desktop login message
      const modalHeader = modal?.querySelector('h2');
      if (modalHeader) {
        modalHeader.textContent = 'ðŸ–¥ï¸ Desktop App Login';
      }
      const modalSubtext = modal?.querySelector('p');
      if (modalSubtext) {
        modalSubtext.textContent = 'Sign in to connect your Axiora Desktop App';
      }
    }
  })();

  // Theme toggle
  document.getElementById('theme-toggle')?.addEventListener('click', () => {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark');

    if (isDark) {
      html.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    } else {
      html.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    }
  });

  // Refresh access token using refresh token
  async function refreshAccessToken() {
    const refreshToken = localStorage.getItem('refresh_token');
    if (!refreshToken) {
      return false;
    }

    try {
      const response = await fetch(`${import.meta.env.PUBLIC_API_URL}/api/v1/auth/refresh`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ refresh_token: refreshToken })
      });

      if (response.ok) {
        const data = await response.json();
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('refresh_token', data.refresh_token);
        return true;
      } else {
        localStorage.clear();
        return false;
      }
    } catch (error) {
      console.error('Error refreshing token:', error);
      return false;
    }
  }

  // Make authenticated API call with automatic token refresh
  async function fetchWithAuth(url, options = {}) {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      throw new Error('No access token');
    }

    const headers = {
      ...options.headers,
      'Authorization': `Bearer ${accessToken}`
    };

    let response = await fetch(url, { ...options, headers });

    if (response.status === 401) {
      const refreshed = await refreshAccessToken();
      if (refreshed) {
        const newAccessToken = localStorage.getItem('access_token');
        headers['Authorization'] = `Bearer ${newAccessToken}`;
        response = await fetch(url, { ...options, headers });
      } else {
        window.location.href = '/signin';
        throw new Error('Session expired');
      }
    }

    return response;
  }

  // Check if user is logged in on page load
  async function checkLoginStatus() {
    const { getCurrentUser, isLoggedIn } = await import('../../lib/auth');
    
    const signinBtn = document.getElementById('signin-btn');
    const userProfile = document.getElementById('user-profile');
    const logoutBtn = document.getElementById('logout-btn');
    
    if (isLoggedIn()) {
      const user = getCurrentUser();
      
      // Get display name with priority: display_name > full_name (Google) > name > email username
      const displayName = user?.user_metadata?.display_name 
        || user?.user_metadata?.full_name 
        || user?.user_metadata?.name
        || user?.email?.split('@')[0] 
        || 'User';
      
      // Get profile image URL (picture field for all sources)
      const avatarUrl = user?.user_metadata?.picture;
      
      // Show user profile and logout button, hide sign in button
      const userDisplayName = document.getElementById('user-display-name');
      const userIcon = document.getElementById('user-icon');
      const userAvatar = document.getElementById('user-avatar');
      
      if (signinBtn) {
        signinBtn.classList.add('hidden');
      }
      
      if (userProfile) {
        userProfile.classList.remove('hidden');
        userProfile.classList.add('md:flex');
      }
      
      if (userDisplayName) {
        userDisplayName.textContent = displayName;
      }
      
      // Show avatar image if available, otherwise show icon
      if (avatarUrl && userAvatar && userIcon) {
        userAvatar.src = avatarUrl;
        userAvatar.classList.remove('hidden');
        userIcon.classList.add('hidden');
      }
      
      // Fetch subscription data and set border color
      try {
        const accessToken = localStorage.getItem('access_token');
        if (accessToken) {
          const response = await fetchWithAuth(`${import.meta.env.PUBLIC_API_URL}/api/v1/users/profile`);
          
          if (response.ok) {
            const profileData = await response.json();
            const planType = profileData?.subscription?.plan_type || 'free';
            
            // Set border color and badge based on plan type
            const planConfig = {
              'pro': { color: '#3b82f6', name: 'Pro' },
              'business': { color: '#10b981', name: 'Business' },
              'enterprise': { color: '#eab308', name: 'Enterprise' },
              'free': { color: '#a855f7', name: 'Free' }
            };
            
            const config = planConfig[planType.toLowerCase()] || planConfig['free'];
            
            if (userAvatar) {
              userAvatar.style.borderColor = config.color;
            }
            if (userIcon) {
              userIcon.style.color = config.color;
            }
            
            // Set plan badge
            const planBadge = document.getElementById('plan-badge');
            if (planBadge) {
              planBadge.textContent = config.name;
              planBadge.style.backgroundColor = config.color;
              planBadge.classList.remove('hidden');
            }
          }
        }
      } catch (error) {
        console.error('Error fetching subscription data:', error);
      }
      
      if (logoutBtn) {
        logoutBtn.classList.remove('hidden');
        logoutBtn.classList.add('md:flex');
      }
    } else {
      // User not logged in - show sign in button
      if (signinBtn) {
        signinBtn.classList.remove('hidden');
        signinBtn.classList.add('md:flex');
      }
      if (userProfile) {
        userProfile.classList.add('hidden');
      }
      if (logoutBtn) {
        logoutBtn.classList.add('hidden');
      }
    }
  }
  
  // Run on page load
  checkLoginStatus();
  
  // User profile dropdown toggle
  const userProfile = document.getElementById('user-profile');
  const userDropdown = document.getElementById('user-dropdown');
  
  userProfile?.addEventListener('click', () => {
    userDropdown?.classList.toggle('hidden');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!userProfile?.contains(e.target) && !userDropdown?.contains(e.target)) {
      userDropdown?.classList.add('hidden');
    }
  });

  // Edit Profile Modal
  const editProfileModal = document.getElementById('edit-profile-modal');
  const editProfileBtn = document.getElementById('edit-profile-btn');
  const closeEditProfile = document.getElementById('close-edit-profile');
  const cancelEditProfile = document.getElementById('cancel-edit-profile');
  const editProfileForm = document.getElementById('edit-profile-form');
  const editDisplayName = document.getElementById('edit-display-name');
  const editAvatarPreview = document.getElementById('edit-avatar-preview');
  const changeAvatarBtn = document.getElementById('change-avatar-btn');
  const avatarUpload = document.getElementById('avatar-upload');
  const editProfileMessage = document.getElementById('edit-profile-message');
  const editProfileMessageText = document.getElementById('edit-profile-message-text');

  let selectedAvatarFile = null;

  // Navigate to usage page
  const seeUsageBtn = document.getElementById('see-usage-btn');
  seeUsageBtn?.addEventListener('click', () => {
    window.location.href = '/usage';
  });

  // Open edit profile modal
  editProfileBtn?.addEventListener('click', async () => {
    const { getCurrentUser } = await import('../../lib/auth');
    const user = getCurrentUser();
    
    if (user) {
      // Pre-fill form with current user data
      const displayName = user?.user_metadata?.display_name 
        || user?.user_metadata?.full_name 
        || user?.user_metadata?.name
        || user?.email?.split('@')[0] 
        || '';
      
      const avatarUrl = user?.user_metadata?.picture || '';
      
      if (editDisplayName) editDisplayName.value = displayName;
      if (editAvatarPreview) editAvatarPreview.src = avatarUrl || '/default-avatar.png';
      
      userDropdown?.classList.add('hidden');
      editProfileModal?.classList.remove('hidden');
      editProfileModal?.classList.add('flex');
    }
  });

  // Close edit profile modal
  closeEditProfile?.addEventListener('click', () => {
    editProfileModal?.classList.add('hidden');
    editProfileModal?.classList.remove('flex');
    selectedAvatarFile = null;
  });

  cancelEditProfile?.addEventListener('click', () => {
    editProfileModal?.classList.add('hidden');
    editProfileModal?.classList.remove('flex');
    selectedAvatarFile = null;
  });

  // Close modal on outside click
  editProfileModal?.addEventListener('click', (e) => {
    if (e.target === editProfileModal) {
      editProfileModal.classList.add('hidden');
      editProfileModal.classList.remove('flex');
      selectedAvatarFile = null;
    }
  });

  // Handle avatar upload
  changeAvatarBtn?.addEventListener('click', () => {
    avatarUpload?.click();
  });

  avatarUpload?.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (file) {
      selectedAvatarFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        if (editAvatarPreview) {
          editAvatarPreview.src = e.target?.result;
        }
      };
      reader.readAsDataURL(file);
    }
  });

  // Handle form submission
  editProfileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const displayName = editDisplayName?.value;
    if (!displayName) return;

    try {
      const { getCurrentUser } = await import('../../lib/auth');
      const user = getCurrentUser();
      
      if (!user) {
        throw new Error('User not logged in');
      }

      const accessToken = localStorage.getItem('access_token');
      if (!accessToken) {
        throw new Error('No access token found');
      }

      // Prepare form data
      const formData = new FormData();
      formData.append('display_name', displayName);
      if (selectedAvatarFile) {
        formData.append('avatar', selectedAvatarFile);
      }

      // Send update request to backend
      const response = await fetch(`${import.meta.env.PUBLIC_API_URL}/api/v1/auth/update-profile`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${accessToken}`
        },
        body: formData
      });

      if (!response.ok) {
        throw new Error('Failed to update profile');
      }

      const data = await response.json();
      
      // Update localStorage with new user data
      localStorage.setItem('user', JSON.stringify(data.user));
      
      // Show success message
      if (editProfileMessage && editProfileMessageText) {
        editProfileMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700');
        editProfileMessage.classList.add('bg-green-100', 'text-green-700');
        editProfileMessageText.textContent = 'Profile updated successfully!';
      }

      // Refresh the page after a short delay
      setTimeout(() => {
        window.location.reload();
      }, 1000);
      
    } catch (error) {
      console.error('Error updating profile:', error);
      
      // Show error message
      if (editProfileMessage && editProfileMessageText) {
        editProfileMessage.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        editProfileMessage.classList.add('bg-red-100', 'text-red-700');
        editProfileMessageText.textContent = error.message || 'Failed to update profile';
      }
    }
  });

  // Logout functionality
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    const { signOut } = await import('../../lib/auth');
    await signOut();
  });

  // Mobile menu toggle
  document.getElementById('mobile-menu-toggle')?.addEventListener('click', () => {
    const menu = document.getElementById('mobile-menu');
    menu?.classList.toggle('hidden');
  });

  // Modal functionality
  const modal = document.getElementById('login-modal');
  const signinBtn = document.getElementById('signin-btn');
  const closeModal = document.getElementById('close-modal');
  const tabSignin = document.getElementById('tab-signin');
  const tabSignup = document.getElementById('tab-signup');
  const signinForm = document.getElementById('signin-form');
  const signupForm = document.getElementById('signup-form');

  // Open modal when clicking sign in button
  signinBtn?.addEventListener('click', () => {
    modal?.classList.remove('hidden');
    modal?.classList.add('flex');
  });

  // Close modal
  closeModal?.addEventListener('click', () => {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
  });

  // Close modal on outside click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  });

  // Tab switching
  tabSignin?.addEventListener('click', () => {
    tabSignin.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignin.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    tabSignup?.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignup?.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    signinForm?.classList.remove('hidden');
    signupForm?.classList.add('hidden');
  });

  tabSignup?.addEventListener('click', () => {
    tabSignup.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignup.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    tabSignin?.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
    tabSignin?.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    signupForm?.classList.remove('hidden');
    signinForm?.classList.add('hidden');
  });

  // API Configuration
  const API_URL = import.meta.env.PUBLIC_API_URL || 'https://axiora-backend-production.up.railway.app';

  // Helper function to show messages
  function showMessage(message: string, isError = false) {
    const messageDiv = document.getElementById('auth-message');
    const messageText = document.getElementById('auth-message-text');
    
    if (messageDiv && messageText) {
      messageText.textContent = message;
      messageDiv.classList.remove('hidden');
      
      if (isError) {
        messageDiv.classList.add('bg-red-100', 'dark:bg-red-900/20', 'border', 'border-red-400', 'dark:border-red-700');
        messageDiv.classList.remove('bg-green-100', 'dark:bg-green-900/20', 'border-green-400', 'dark:border-green-700');
        messageText.classList.add('text-red-700', 'dark:text-red-300');
        messageText.classList.remove('text-green-700', 'dark:text-green-300');
      } else {
        messageDiv.classList.add('bg-green-100', 'dark:bg-green-900/20', 'border', 'border-green-400', 'dark:border-green-700');
        messageDiv.classList.remove('bg-red-100', 'dark:bg-red-900/20', 'border-red-400', 'dark:border-red-700');
        messageText.classList.add('text-green-700', 'dark:text-green-300');
        messageText.classList.remove('text-red-700', 'dark:text-red-300');
      }
      
      setTimeout(() => {
        messageDiv.classList.add('hidden');
      }, 5000);
    }
  }

  // Email Sign In
  document.getElementById('email-signin-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const email = (form.elements.namedItem('email') as HTMLInputElement).value;
    const password = (form.elements.namedItem('password') as HTMLInputElement).value;

    try {
      const response = await fetch(`${API_URL}/api/v1/auth/signin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();

      if (response.ok) {
        const { saveSession } = await import('../../lib/auth');
        saveSession(data.access_token, data.refresh_token, data.user);
        showMessage('Successfully signed in!');
        
        // Check if this is a desktop login
        const desktopCallback = localStorage.getItem('desktop_callback');
        
        if (desktopCallback) {
          // Desktop app login - redirect to backend callback
          const accessToken = data.access_token;
          const callbackUrl = `${desktopCallback}&access_token=${accessToken}`;
          localStorage.removeItem('desktop_callback');
          window.location.href = callbackUrl;
        } else {
          // Normal website login - reload page
          setTimeout(() => {
            modal?.classList.add('hidden');
            modal?.classList.remove('flex');
            window.location.reload();
          }, 1500);
        }
      } else {
        showMessage(data.detail || 'Sign in failed', true);
      }
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });

  // Email Sign Up
  document.getElementById('email-signup-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const name = (form.elements.namedItem('name') as HTMLInputElement).value;
    const email = (form.elements.namedItem('email') as HTMLInputElement).value;
    const password = (form.elements.namedItem('password') as HTMLInputElement).value;

    try {
      const response = await fetch(`${API_URL}/api/v1/auth/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          email, 
          password,
          user_metadata: {
            display_name: name
          }
        })
      });

      const data = await response.json();

      if (response.ok) {
        const { saveSession } = await import('../../lib/auth');
        
        if (data.email_confirmed) {
          saveSession(data.access_token, data.refresh_token, data.user);
          showMessage('Account created successfully!');
          
          // Check if this is a desktop login
          const desktopCallback = localStorage.getItem('desktop_callback');
          
          if (desktopCallback) {
            // Desktop app login - redirect to backend callback
            const accessToken = data.access_token;
            const callbackUrl = `${desktopCallback}&access_token=${accessToken}`;
            localStorage.removeItem('desktop_callback');
            window.location.href = callbackUrl;
          } else {
            // Normal website signup - reload page
            setTimeout(() => {
              modal?.classList.add('hidden');
              modal?.classList.remove('flex');
              window.location.reload();
            }, 1500);
          }
        } else {
          showMessage('Account created! Please check your email to verify your account.');
          form.reset();
        }
      } else {
        showMessage(data.detail || 'Sign up failed', true);
      }
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });

  // Google Sign In (Client-side with Supabase)
  document.getElementById('google-signin-btn')?.addEventListener('click', async () => {
    try {
      // Import Supabase client dynamically
      const { supabase } = await import('../../lib/supabase');
      
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + '/auth/callback'
        }
      });

      if (error) {
        showMessage('Google sign in failed: ' + error.message, true);
      }
      // If successful, user will be redirected to Google
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });

  // Google Sign Up (same as sign in for OAuth)
  document.getElementById('google-signup-btn')?.addEventListener('click', async () => {
    try {
      // Import Supabase client dynamically
      const { supabase } = await import('../../lib/supabase');
      
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + '/auth/callback'
        }
      });

      if (error) {
        showMessage('Google sign up failed: ' + error.message, true);
      }
      // If successful, user will be redirected to Google
    } catch (error) {
      showMessage('Network error. Please try again.', true);
    }
  });
</script>
