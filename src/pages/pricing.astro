---
import Layout from '../layouts/Layout.astro';
import Header from '../components/widgets/Header.astro';
import Footer from '../components/widgets/Footer.astro';
import { Icon } from 'astro-icon/components';

const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.axiora.software';
---

<Layout title="Pricing - Axiora" description="Choose the perfect plan for your data analysis needs">
  <Header />
  
  <main class="min-h-screen bg-gradient-to-b from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header Section -->
      <div class="text-center mb-16">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
          Simple, Transparent Pricing
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
          Choose the plan that fits your needs. All plans include core features.
        </p>
      </div>

      <!-- Loading State -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-4 text-gray-600 dark:text-gray-400">Loading pricing plans...</p>
      </div>

      <!-- Error Message -->
      <div id="error" class="hidden mb-8 p-4 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg"></div>

      <!-- Pricing Cards Container -->
      <div id="pricing-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 hidden"></div>
      
      <!-- FAQ Section -->
      <div class="mt-20 text-center">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
          Have questions?
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          We're here to help. Contact our support team for any inquiries.
        </p>
        <a 
          href="#footer" 
          class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          <Icon name="tabler:mail" class="w-5 h-5" />
          Contact Support
        </a>
      </div>
    </div>
  </main>
  
  <Footer />

  <script define:vars={{ API_URL }}>
    // Plan features mapping
    const planFeatures = {
      free: [
        'Basic data analysis',
        '100 API calls per month',
        'Standard report generation',
        'Email support',
        'Community access'
      ],
      pro: [
        'Advanced data analysis',
        '1,000 API calls per month',
        'Premium report generation',
        'Priority email support',
        'Advanced visualizations',
        'Export to multiple formats',
        'API access'
      ],
      business: [
        'Business-grade analysis',
        '5,000 API calls per month',
        'Custom report templates',
        'Priority support',
        'Advanced analytics',
        'Multiple exports',
        'Full API access',
        'Team collaboration',
        'Custom branding'
      ],
      enterprise: [
        'Enterprise-grade analysis',
        '10,000 API calls per month',
        'Custom report templates',
        '24/7 dedicated support',
        'Advanced analytics',
        'Unlimited exports',
        'Full API access',
        'Custom integrations',
        'SLA guarantee'
      ],
      developing: [
        'Full development access',
        'Unlimited API calls',
        'All features unlocked',
        'Direct developer support',
        'Beta features access',
        'Custom development'
      ]
    };

    // Plan order for display
    const planOrder = ['free', 'pro', 'business', 'enterprise'];

    // Calculate discounted price
    function getDiscountedPrice(cost, discount) {
      return cost - (cost * discount / 100);
    }

    // Create plan card HTML
    function createPlanCard(plan) {
      const isComingSoon = plan.availability === 'Comingsoon';
      const hasDiscount = plan.discount > 0;
      const discountedPrice = hasDiscount ? getDiscountedPrice(plan.cost, plan.discount) : plan.cost;
      const features = planFeatures[plan.type] || [];
      const isPopular = plan.type === 'pro';
      
      const popularBadge = isPopular ? `
        <div class="absolute top-0 right-0 bg-blue-500 text-white px-4 py-1 text-sm font-semibold rounded-bl-lg">
          Popular
        </div>
      ` : '';
      
      const comingSoonBadge = isComingSoon ? `
        <div class="absolute top-0 left-0 right-0 bg-yellow-500 text-white text-center py-2 text-sm font-semibold">
          Coming Soon
        </div>
      ` : '';
      
      const priceHTML = plan.cost === -1 ? `
        <div class="text-3xl font-bold text-gray-900 dark:text-white">
          Contact Us
        </div>
      ` : `
        <div class="flex items-baseline gap-2">
          ${hasDiscount ? `
            <span class="text-2xl text-gray-400 dark:text-gray-500 line-through">
              $${plan.cost.toFixed(2)}
            </span>
          ` : ''}
          <span class="text-4xl font-bold text-gray-900 dark:text-white">
            $${discountedPrice.toFixed(2)}
          </span>
          <span class="text-gray-600 dark:text-gray-400">/month</span>
        </div>
      `;
      
      const discountBadge = hasDiscount ? `
        <div class="mt-2 inline-block bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1 rounded-full text-sm font-semibold">
          Save ${plan.discount}%
        </div>
      ` : '';
      
      const featuresHTML = features.map(feature => `
        <li class="flex items-start">
          <svg class="w-5 h-5 text-green-500 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="text-gray-600 dark:text-gray-300">${feature}</span>
        </li>
      `).join('');
      
      let buttonHTML;
      if (isComingSoon) {
        buttonHTML = `
          <button disabled class="w-full py-3 px-6 rounded-lg font-semibold bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed">
            Coming Soon
          </button>
        `;
      } else if (plan.type === 'developing') {
        buttonHTML = `
          <a href="#footer" class="block w-full py-3 px-6 rounded-lg font-semibold text-center bg-purple-600 hover:bg-purple-700 text-white transition-colors">
            Contact Us
          </a>
        `;
      } else {
        const buttonClass = isPopular 
          ? 'bg-blue-600 hover:bg-blue-700 text-white' 
          : 'bg-gray-900 hover:bg-gray-800 dark:bg-white dark:hover:bg-gray-100 text-white dark:text-gray-900';
        buttonHTML = `
          <a href="/coming-soon" class="block w-full py-3 px-6 rounded-lg font-semibold text-center transition-colors ${buttonClass}">
            Get Started
          </a>
        `;
      }
      
      return `
        <div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden transition-transform hover:scale-105 ${isPopular ? 'ring-2 ring-blue-500' : ''}">
          ${popularBadge}
          ${comingSoonBadge}
          
          <div class="p-8 ${isComingSoon ? 'mt-10' : ''}">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white capitalize mb-2">
              ${plan.type}
            </h3>
            
            <div class="mb-6">
              ${priceHTML}
              ${discountBadge}
            </div>
            
            <div class="mb-6 text-gray-600 dark:text-gray-400">
              <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              ${plan.allowed_calls === 999999 ? 'Unlimited' : plan.allowed_calls.toLocaleString()} API calls
            </div>
            
            <ul class="space-y-3 mb-8">
              ${featuresHTML}
            </ul>
            
            ${buttonHTML}
          </div>
        </div>
      `;
    }

    // Fetch and render plans
    async function loadPlans() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const cardsEl = document.getElementById('pricing-cards');
      
      try {
        const url = `${API_URL}/api/v1/users/subscription/plans`;
        console.log('Fetching plans from:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        let plans = await response.json();
        console.log('Plans fetched:', plans);
        
        // Filter out developing plan
        plans = plans.filter(plan => plan.type !== 'developing');
        
        // Sort plans by the defined order
        plans.sort((a, b) => {
          const orderA = planOrder.indexOf(a.type);
          const orderB = planOrder.indexOf(b.type);
          return orderA - orderB;
        });
        
        if (plans.length === 0) {
          throw new Error('No subscription plans available');
        }
        
        // Render plans
        cardsEl.innerHTML = plans.map(plan => createPlanCard(plan)).join('');
        
        // Show cards, hide loading
        loadingEl.classList.add('hidden');
        cardsEl.classList.remove('hidden');
        
      } catch (error) {
        console.error('Failed to load plans:', error);
        
        // Show error
        loadingEl.classList.add('hidden');
        errorEl.textContent = `Failed to load pricing plans: ${error.message}`;
        errorEl.classList.remove('hidden');
      }
    }

    // Load plans when page loads
    loadPlans();
  </script>
</Layout>
