---
import Layout from '../layouts/Layout.astro';
import Header from '../components/widgets/Header.astro';
import Footer from '../components/widgets/Footer.astro';
import { Icon } from 'astro-icon/components';

// Fetch subscription plans from backend
const API_URL = import.meta.env.PUBLIC_API_URL || 'https://axiora-backend-production.up.railway.app';

let plans = [];
try {
  const response = await fetch(`${API_URL}/api/v1/users/subscription/plans`);
  if (response.ok) {
    plans = await response.json();
  }
} catch (error) {
  console.error('Failed to fetch subscription plans:', error);
}

// Plan features mapping
const planFeatures = {
  free: [
    'Basic data analysis',
    '100 API calls per month',
    'Standard report generation',
    'Email support',
    'Community access'
  ],
  pro: [
    'Advanced data analysis',
    '1,000 API calls per month',
    'Premium report generation',
    'Priority email support',
    'Advanced visualizations',
    'Export to multiple formats',
    'API access'
  ],
  enterprise: [
    'Enterprise-grade analysis',
    '10,000 API calls per month',
    'Custom report templates',
    '24/7 dedicated support',
    'Advanced analytics',
    'Unlimited exports',
    'Full API access',
    'Custom integrations',
    'SLA guarantee'
  ],
  developing: [
    'Full development access',
    'Unlimited API calls',
    'All features unlocked',
    'Direct developer support',
    'Beta features access',
    'Custom development'
  ]
};

// Calculate discounted price
function getDiscountedPrice(cost: number, discount: number): number {
  return cost - (cost * discount / 100);
}
---

<Layout title="Pricing - Axiora" description="Choose the perfect plan for your data analysis needs">
  <Header />
  
  <main class="min-h-screen bg-gradient-to-b from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header Section -->
      <div class="text-center mb-16">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
          Simple, Transparent Pricing
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
          Choose the plan that fits your needs. All plans include core features.
        </p>
      </div>

      <!-- Pricing Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
        {plans.map((plan) => {
          const isComingSoon = plan.availability === 'Comingsoon';
          const hasDiscount = plan.discount > 0;
          const discountedPrice = hasDiscount ? getDiscountedPrice(plan.cost, plan.discount) : plan.cost;
          const features = planFeatures[plan.type as keyof typeof planFeatures] || [];
          const isPopular = plan.type === 'pro';
          
          return (
            <div class={`relative bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden transition-transform hover:scale-105 ${isPopular ? 'ring-2 ring-blue-500' : ''}`}>
              {/* Popular Badge */}
              {isPopular && (
                <div class="absolute top-0 right-0 bg-blue-500 text-white px-4 py-1 text-sm font-semibold rounded-bl-lg">
                  Popular
                </div>
              )}
              
              {/* Coming Soon Badge */}
              {isComingSoon && (
                <div class="absolute top-0 left-0 right-0 bg-yellow-500 text-white text-center py-2 text-sm font-semibold">
                  Coming Soon
                </div>
              )}
              
              <div class={`p-8 ${isComingSoon ? 'mt-10' : ''}`}>
                {/* Plan Name */}
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white capitalize mb-2">
                  {plan.type}
                </h3>
                
                {/* Price */}
                <div class="mb-6">
                  {plan.cost === -1 ? (
                    <div class="text-3xl font-bold text-gray-900 dark:text-white">
                      Contact Us
                    </div>
                  ) : (
                    <div class="flex items-baseline gap-2">
                      {hasDiscount && (
                        <span class="text-2xl text-gray-400 dark:text-gray-500 line-through">
                          ${plan.cost.toFixed(2)}
                        </span>
                      )}
                      <span class="text-4xl font-bold text-gray-900 dark:text-white">
                        ${discountedPrice.toFixed(2)}
                      </span>
                      <span class="text-gray-600 dark:text-gray-400">/month</span>
                    </div>
                  )}
                  
                  {hasDiscount && (
                    <div class="mt-2 inline-block bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1 rounded-full text-sm font-semibold">
                      Save {plan.discount}%
                    </div>
                  )}
                </div>
                
                {/* API Calls */}
                <div class="mb-6 text-gray-600 dark:text-gray-400">
                  <Icon name="tabler:api" class="w-5 h-5 inline mr-2" />
                  {plan.allowed_calls === 999999 ? 'Unlimited' : plan.allowed_calls.toLocaleString()} API calls
                </div>
                
                {/* Features List */}
                <ul class="space-y-3 mb-8">
                  {features.map((feature) => (
                    <li class="flex items-start">
                      <Icon name="tabler:check" class="w-5 h-5 text-green-500 mr-3 flex-shrink-0 mt-0.5" />
                      <span class="text-gray-600 dark:text-gray-300">{feature}</span>
                    </li>
                  ))}
                </ul>
                
                {/* CTA Button */}
                {isComingSoon ? (
                  <button 
                    disabled 
                    class="w-full py-3 px-6 rounded-lg font-semibold bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                  >
                    Coming Soon
                  </button>
                ) : plan.type === 'developing' ? (
                  <a 
                    href="#footer" 
                    class="block w-full py-3 px-6 rounded-lg font-semibold text-center bg-purple-600 hover:bg-purple-700 text-white transition-colors"
                  >
                    Contact Us
                  </a>
                ) : (
                  <a 
                    href="/coming-soon" 
                    class={`block w-full py-3 px-6 rounded-lg font-semibold text-center transition-colors ${
                      isPopular 
                        ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                        : 'bg-gray-900 hover:bg-gray-800 dark:bg-white dark:hover:bg-gray-100 text-white dark:text-gray-900'
                    }`}
                  >
                    Get Started
                  </a>
                )}
              </div>
            </div>
          );
        })}
      </div>
      
      {/* FAQ Section */}
      <div class="mt-20 text-center">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
          Have questions?
        </h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">
          We're here to help. Contact our support team for any inquiries.
        </p>
        <a 
          href="#footer" 
          class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          <Icon name="tabler:mail" class="w-5 h-5" />
          Contact Support
        </a>
      </div>
    </div>
  </main>
  
  <Footer />
</Layout>
