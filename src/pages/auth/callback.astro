---
import Layout from '../../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
---

<Layout title="Authentication - Axiora">
  <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-900 dark:via-blue-900/20 dark:to-purple-900/20">
    <div class="max-w-md mx-auto text-center px-4">
      <div id="loading" class="mb-8">
        <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-full inline-block mb-4 animate-pulse">
          <Icon name="tabler:loader-2" class="w-16 h-16 text-blue-600 dark:text-blue-400 animate-spin" />
        </div>
        
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          Completing Sign In...
        </h1>
        
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Please wait while we authenticate your account.
        </p>
      </div>

      <div id="error" class="hidden">
        <div class="bg-red-100 dark:bg-red-900 p-4 rounded-full inline-block mb-4">
          <Icon name="tabler:alert-circle" class="w-16 h-16 text-red-600 dark:text-red-400" />
        </div>
        
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          Authentication Failed
        </h1>
        
        <p id="error-message" class="text-lg text-gray-600 dark:text-gray-300 mb-8">
          Something went wrong during authentication.
        </p>

        <a
          href="/"
          class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors duration-200"
        >
          <Icon name="tabler:home" class="w-5 h-5 mr-2" />
          Back to Home
        </a>
      </div>
    </div>
  </div>
</Layout>

<script>
  async function handleCallback() {
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const errorMessage = document.getElementById('error-message');

    try {
      // Import Supabase client
      const { supabase } = await import('../../lib/supabase');

      // Check for error in URL
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');

      if (error) {
        loadingDiv?.classList.add('hidden');
        errorDiv?.classList.remove('hidden');
        if (errorMessage) {
          errorMessage.textContent = errorDescription || 'Authentication was cancelled or failed.';
        }
        return;
      }

      // Get the session from Supabase (it handles the OAuth callback automatically)
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError) {
        loadingDiv?.classList.add('hidden');
        errorDiv?.classList.remove('hidden');
        if (errorMessage) {
          errorMessage.textContent = 'Failed to get session: ' + sessionError.message;
        }
        return;
      }

      if (session) {
        // Store session using auth utility
        const { saveSession } = await import('../../lib/auth');
        saveSession(session.access_token, session.refresh_token, session.user);

        // Ensure user has a subscription (for new users)
        try {
          const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.axiora.software';
          await fetch(`${API_URL}/api/v1/users/subscription/ensure`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json'
            }
          });
        } catch (subError) {
          console.warn('Failed to ensure subscription:', subError);
          // Don't block the login flow if subscription creation fails
        }

        // Check if this is a desktop login
        const desktopCallback = localStorage.getItem('desktop_callback');
        
        if (desktopCallback) {
          // Desktop app login - redirect to backend callback with access token
          const accessToken = session.access_token;
          const callbackUrl = `${desktopCallback}&access_token=${accessToken}`;
          
          // Clear stored callback
          localStorage.removeItem('desktop_callback');
          
          // Redirect to backend (will show success page and complete desktop login)
          window.location.href = callbackUrl;
        } else {
          // Normal website login - redirect to home
          window.location.href = '/';
        }
      } else {
        // No session found, might still be processing
        // Wait a bit and try again
        setTimeout(async () => {
          const { data: { session: retrySession } } = await supabase.auth.getSession();
          
          if (retrySession) {
            const { saveSession } = await import('../../lib/auth');
            saveSession(retrySession.access_token, retrySession.refresh_token, retrySession.user);
            
            // Ensure user has a subscription (for new users)
            try {
              const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.axiora.software';
              await fetch(`${API_URL}/api/v1/users/subscription/ensure`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${retrySession.access_token}`,
                  'Content-Type': 'application/json'
                }
              });
            } catch (subError) {
              console.warn('Failed to ensure subscription:', subError);
            }
            
            // Check for desktop callback again
            const desktopCallback = localStorage.getItem('desktop_callback');
            if (desktopCallback) {
              const accessToken = retrySession.access_token;
              const callbackUrl = `${desktopCallback}&access_token=${accessToken}`;
              localStorage.removeItem('desktop_callback');
              window.location.href = callbackUrl;
            } else {
              window.location.href = '/';
            }
          } else {
            loadingDiv?.classList.add('hidden');
            errorDiv?.classList.remove('hidden');
            if (errorMessage) {
              errorMessage.textContent = 'No session found. Please try again.';
            }
          }
        }, 1000);
      }
    } catch (error) {
      loadingDiv?.classList.add('hidden');
      errorDiv?.classList.remove('hidden');
      if (errorMessage) {
        errorMessage.textContent = 'An error occurred: ' + (error as Error).message;
      }
    }
  }

  // Run callback handler when page loads
  handleCallback();
</script>
